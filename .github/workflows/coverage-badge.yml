name: Coverage Badge

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      # istanbul json-summary generates reports/coverage-summary.json
      # { "total": { "lines": { "pct": 98 }, "branches": { "pct": 95 }, ... } }
      - name: Extract coverage percentage
        id: coverage
        run: |
          PCT=$(node -e "
            const s = require('./reports/coverage-summary.json').total;
            const pct = ((s.lines.pct + s.statements.pct + s.branches.pct + s.functions.pct) / 4).toFixed(1);
            process.stdout.write(pct);
          ")
          echo "pct=$PCT" >> $GITHUB_OUTPUT
          echo "Coverage: $PCT%"

      - name: Pick badge color
        id: color
        run: |
          COLOR=$(node -e "
            const p = parseFloat('${{ steps.coverage.outputs.pct }}');
            if      (p >= 90) process.stdout.write('brightgreen');
            else if (p >= 75) process.stdout.write('green');
            else if (p >= 60) process.stdout.write('yellow');
            else if (p >= 40) process.stdout.write('orange');
            else              process.stdout.write('red');
          ")
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      - name: Generate badge SVG
        run: |
          mkdir -p badges
          PCT="${{ steps.coverage.outputs.pct }}%"
          COLOR="${{ steps.color.outputs.color }}"
          LABEL="coverage"

          case "$COLOR" in
            brightgreen) HEX="#4c1"    ;;
            green)       HEX="#97ca00" ;;
            yellow)      HEX="#dfb317" ;;
            orange)      HEX="#fe7d37" ;;
            *)           HEX="#e05d44" ;;
          esac

          LW=$(node -e "process.stdout.write(String(Math.round(${#LABEL} * 6.5 + 32)))")
          RW=$(node -e "process.stdout.write(String(Math.round(${#PCT}   * 6.5 + 32)))")
          TW=$(( LW + RW ))
          LMX=$(( LW / 2 ))
          RMX=$(( LW + RW / 2 ))

          cat > badges/coverage.svg << SVGEOF
          <svg xmlns="http://www.w3.org/2000/svg" width="${TW}" height="20">
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0"  stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1"                    stop-opacity=".1"/>
            </linearGradient>
            <clipPath id="r">
              <rect width="${TW}" height="20" rx="3" fill="#fff"/>
            </clipPath>
            <g clip-path="url(#r)">
              <rect width="${LW}"  height="20" fill="#555"/>
              <rect x="${LW}" width="${RW}" height="20" fill="${HEX}"/>
              <rect width="${TW}"  height="20" fill="url(#s)"/>
            </g>
            <g fill="#fff" text-anchor="middle"
               font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="${LMX}" y="15" fill="#010101" fill-opacity=".3">${LABEL}</text>
              <text x="${LMX}" y="14">${LABEL}</text>
              <text x="${RMX}" y="15" fill="#010101" fill-opacity=".3">${PCT}</text>
              <text x="${RMX}" y="14">${PCT}</text>
            </g>
          </svg>
          SVGEOF

      - name: Commit badge
        if: github.event_name == 'push'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add badges/coverage.svg
          git diff --cached --quiet || git commit -m "chore: update coverage badge [skip ci]"
          git push
